<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Addition Quiz ‚Ä¢ Fixed & Working</title>
<style>
  :root{
    --bg:#fafafa;--fg:#111;--border:#d9d9d9;
    --ok:#14ae5c;--bad:#e53935;
    --aColor:#4da6ff;--bColor:#ff77b4;--ansColor:#6c7a89;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,sans-serif;
       display:flex;flex-direction:column;align-items:center;min-height:100vh}
  header{width:100%;max-width:960px;padding:14px 16px;
         display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:22px;font-weight:900}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button,select,label{border:1px solid var(--border);background:#fff;color:#111;
    border-radius:12px;padding:10px 14px;font-size:15px;font-weight:700;cursor:pointer;min-height:44px}
  button.primary{background:#111;color:#fff;border-color:#111}

  main{width:100%;max-width:960px;padding:8px 16px 20px;display:flex;flex-direction:column;gap:16px}

  .topbar{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff;
          display:flex;flex-direction:column;gap:8px}
  .status{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--border);font-weight:800}
  .pill.mono{font-family:ui-monospace,monospace}
  .prompt{font-weight:900;font-size:18px}

  .quiz{border:1px solid var(--border);border-radius:12px;background:#fff;padding:16px;
        display:flex;flex-direction:column;gap:16px}

  .groups{
    display:grid;
    grid-template-columns: 1fr auto 1fr auto 1fr; /* A | + | B | = | Answer */
    grid-template-rows: auto auto;                /* Row1 numbers, Row2 blocks */
    gap:10px 12px;
    align-items:center;
    justify-items:center;
  }

  /* Problem numbers */
  .numBig{
    font-weight:900;font-size:64px;line-height:1;
    width:160px;height:100px;text-align:center;padding:10px;
    border-radius:16px;border:3px solid currentColor;background:#fff;
  }
  .numA{color:var(--aColor)} .numB{color:var(--bColor)}

  /* Answer: empty small ‚Üí typing big (matches numbers) */
  .answerInput{
    font-weight:900;line-height:1;
    width:160px;height:100px;text-align:center;padding:10px;
    border-radius:16px;border:3px solid var(--ansColor);color:var(--ansColor);background:#fff;
    transition:border-color .15s, box-shadow .15s, transform .08s, font-size .08s;
    font-size:34px; /* empty state */
  }
  .answerInput.filled{font-size:64px;} /* when typing */
  .answerInput.good{border-color:var(--ok);box-shadow:0 0 0 4px rgba(20,174,92,.15)}
  .answerInput.bad{border-color:var(--bad);box-shadow:0 0 0 4px rgba(229,57,53,.12)}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-2px)}}
  .shake{animation:shake .25s linear}

  .sign{font-size:48px;font-weight:900;padding:4px 8px}

  /* Blocks (1.5√ó bigger) ‚Äî 5 per row */
  .numBlocks{
    display:grid;
    grid-template-columns:repeat(5, 27px);
    grid-auto-rows:27px;
    gap:6px;
    justify-content:center;
    max-width:390px;
    min-height:36px;
  }
  .nb{width:27px;height:27px;border-radius:6px;border:1px solid rgba(0,0,0,.08);
      background:currentColor;opacity:.25}
  .blocksA{color:var(--aColor)} .blocksB{color:var(--bColor)} .blocksAns{color:var(--ansColor)}

  /* Grid placement */
  #numA{grid-column:1; grid-row:1}
  #plus{grid-column:2; grid-row:1}
  #numB{grid-column:3; grid-row:1}
  #equal{grid-column:4; grid-row:1}
  #answer{grid-column:5; grid-row:1}
  #blocksA{grid-column:1; grid-row:2}
  #blocksB{grid-column:3; grid-row:2}
  #ansBlocks{grid-column:5; grid-row:2}
  .signSpacer{grid-row:2; width:1px; height:36px; opacity:0}
  #plusSpacer{grid-column:2} #equalSpacer{grid-column:4}

  /* Keypad: big pastel buttons */
  .keypad{display:grid;grid-template-columns:repeat(5,90px);gap:10px;justify-content:center}
  .keypad button{
    min-height:72px;font-size:22px;font-weight:800;border:none;border-radius:14px;
    box-shadow:0 2px 0 rgba(0,0,0,.06);cursor:pointer;
    transition:transform .06s ease, box-shadow .12s ease;
  }
  .keypad button:active{transform:translateY(1px);box-shadow:0 1px 0 rgba(0,0,0,.05)}
  .p-red{background:#ffd6d6}.p-orange{background:#ffe2c4}.p-yellow{background:#fff5b8}
  .p-green{background:#dff7c8}.p-blue{background:#d9eaff}.p-indigo{background:#e3dcff}
  .p-violet{background:#f0d9ff}.p-pink{background:#ffd9ec}.p-mint{background:#dff7f2}.p-gray{background:#e9eef2}

  .sparkle{position:fixed;width:10px;height:10px;pointer-events:none;border-radius:50%;
    background:radial-gradient(circle,#fff,transparent);animation:sparkle .7s ease-out forwards}
  @keyframes sparkle{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(0.2);opacity:0}}

  footer{padding:14px;color:#666;font-size:14px;text-align:center}
</style>
</head>
<body>
<header>
  <h1>‚ûï Addition Quiz</h1>
  <div class="controls">
    <label for="levelSel">Level:</label>
    <select id="levelSel">
      <option value="1" selected>1 (sum ‚â§ 10)</option>
      <option value="2">2 (sum ‚â• 10)</option>
    </select>

    <label for="rangeSel">Max:</label>
    <select id="rangeSel">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
    </select>

    <button id="make10Btn">Make 10</button>
    <button id="newBtn">üé≤ New Problem</button>
    <button id="voiceBtn" class="primary">üó£Ô∏è Voice On</button>
  </div>
</header>

<main>
  <div class="topbar">
    <div class="status">
      <span class="pill" id="modePill">Mode: Quiz</span>
      <span class="pill">Target: <strong id="targetLabel">‚Äî</strong></span>
      <span class="pill mono" id="eqPill">0 + 0 = ?</span>
    </div>
    <span class="prompt" id="promptText">Listen and type your answer!</span>
  </div>

  <div class="quiz">
    <div class="groups">
      <div id="numA" class="numBig numA">0</div>
      <div id="plus" class="sign">+</div>
      <div id="numB" class="numBig numB">0</div>
      <div id="equal" class="sign">=</div>
      <input id="answer" class="answerInput" inputmode="numeric" maxlength="2" placeholder="Answer"/>

      <div id="blocksA" class="numBlocks blocksA"></div>
      <div id="plusSpacer" class="signSpacer"></div>
      <div id="blocksB" class="numBlocks blocksB"></div>
      <div id="equalSpacer" class="signSpacer"></div>
      <div id="ansBlocks" class="numBlocks blocksAns"></div>
    </div>

    <div class="keypad" id="keypad"></div>
  </div>
</main>

<footer>Fixed build: keypad visible, blocks 5 per row, English voice</footer>

<script>
(()=> {
/* ==== Elements ==== */
const numAEl=document.getElementById('numA'),numBEl=document.getElementById('numB');
const blocksA=document.getElementById('blocksA'),blocksB=document.getElementById('blocksB'),ansBlocks=document.getElementById('ansBlocks');
const answerInput=document.getElementById('answer'),newBtn=document.getElementById('newBtn');
const make10Btn=document.getElementById('make10Btn'),rangeSel=document.getElementById('rangeSel'),levelSel=document.getElementById('levelSel');
const eqPill=document.getElementById('eqPill'),modePill=document.getElementById('modePill'),targetLabel=document.getElementById('targetLabel');
const keypad=document.getElementById('keypad'),voiceBtn=document.getElementById('voiceBtn');

/* ==== Audio ==== */
let audioCtx=null;
function ensureAudio(){ if(!audioCtx){ const AC=window.AudioContext||window.webkitAudioContext; audioCtx=AC?new AC():null; } }
function winSound(){ ensureAudio(); if(!audioCtx) return;
  const notes=[523,659,784,1046], now=audioCtx.currentTime;
  notes.forEach((f,i)=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='triangle'; o.frequency.value=f;
    const t=now+i*0.09; g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.25,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.08);
    o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.12);
  });
}
function oopsBeep(){ ensureAudio(); if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain(), now=audioCtx.currentTime;
  o.type='square'; o.frequency.value=220; g.gain.value=0.15;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(now); o.stop(now+0.18);
}

/* ==== TTS ==== */
let voiceOn=true,voiceEN=null;
function pickEnVoice(){
  const list = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
  if(!list || !list.length) return null;
  return list.find(v=>/^en(-|_)?US/i.test(v.lang)) || list.find(v=>/^en/i.test(v.lang)) || null;
}
function prepareVoices(){
  voiceEN = pickEnVoice();
  if(!voiceEN && window.speechSynthesis){
    window.speechSynthesis.addEventListener('voiceschanged', ()=>{ voiceEN=pickEnVoice(); }, {once:true});
  }
}
function speakQuestion(a,b){
  if(!voiceOn || !window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(`What is ${a} plus ${b}?`);
  u.lang='en-US'; if(voiceEN) u.voice=voiceEN;
  try{ window.speechSynthesis.cancel(); }catch(e){}
  window.speechSynthesis.speak(u);
}

/* ==== State ==== */
let maxN=10, make10=false, level=1, A=0, B=0, S=0;
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function buildBlocks(el,n){
  el.innerHTML='';
  const cap=Math.max(0,Math.min(20,n));
  for(let i=0;i<cap;i++){
    const d=document.createElement('div'); d.className='nb'; el.appendChild(d);
  }
}

/* ==== Problem generator ==== */
function newProblem(){
  if(make10){
    const t=10; S=t; A=randInt(0,t); B=t-A;
    modePill.textContent='Mode: Make 10'; targetLabel.textContent='10';
  }else{
    modePill.textContent='Mode: Quiz';
    if(level===1){
      const sumMax = Math.min(10, Math.max(0, maxN));
      S = randInt(0, sumMax);
    }else{
      const sumMin = 10;
      const sumMax = Math.max(10, Math.min(20, maxN));
      S = randInt(sumMin, sumMax);
    }
    A = randInt(0, S);
    B = S - A;
    targetLabel.textContent = `${A}+${B}`;
  }

  numAEl.textContent=A; numBEl.textContent=B;
  eqPill.textContent=`${A}+${B}=?`;
  buildBlocks(blocksA,A); buildBlocks(blocksB,B); buildBlocks(ansBlocks,0);
  clearAnswer();
  speakQuestion(A,B);
}

/* ==== Answer & feedback ==== */
function setAnswer(v){ answerInput.value=v; }
function setFilledState(){ if((answerInput.value||'').trim().length>0){ answerInput.classList.add('filled'); } else { answerInput.classList.remove('filled'); } }
function clearAnswer(){ setAnswer(''); answerInput.classList.remove('good','bad','shake','filled'); answerInput.focus(); }
let lastWrong=null;
function evaluate(){
  const raw=(answerInput.value||'').trim();
  const val=parseInt(raw,10);
  setFilledState();

  // update visual blocks for the typed answer
  buildBlocks(ansBlocks, isNaN(val)?0:val);

  if(raw===''){ answerInput.classList.remove('good','bad','shake'); return; }

  // two-digit tolerance
  if(S>=10 && raw.length===1){
    const firstDigit=parseInt(raw,10);
    const tens=Math.floor(S/10);
    if(firstDigit===tens){ answerInput.classList.remove('good','bad','shake'); return; }
  }

  if(!isNaN(val) && val===S){
    answerInput.classList.remove('bad','shake'); answerInput.classList.add('good');
    const r=answerInput.getBoundingClientRect(); sparkles(r.left+r.width/2, r.top+r.height/2);
    winSound(); eqPill.textContent=`${A}+${B}=${S}`;
    setTimeout(()=>newProblem(),900);
  }else{
    answerInput.classList.remove('good'); answerInput.classList.add('bad','shake');
    if(lastWrong!==val){ oopsBeep(); lastWrong=val; }
    setTimeout(()=>answerInput.classList.remove('shake'),250);
  }
}

/* ==== Keypad ==== */
function buildKeypad(){
  keypad.innerHTML='';
  const pastel=['p-red','p-orange','p-yellow','p-green','p-blue','p-indigo','p-violet','p-pink','p-mint','p-gray'];
  for(let i=0;i<=9;i++){
    const b=document.createElement('button');
    b.textContent=i; b.className=pastel[i%pastel.length];
    b.addEventListener('click',()=>{
      if(answerInput.value.length<2){ answerInput.value+=i; evaluate(); }
    });
    keypad.appendChild(b);
  }
}

/* Sparkles */
function sparkles(x,y,n=12){
  for(let i=0;i<n;i++){
    const s=document.createElement('div'); s.className='sparkle';
    const ang=Math.random()*Math.PI*2, dist=40+Math.random()*40;
    s.style.left=`${x}px`; s.style.top=`${y}px`;
    s.style.setProperty('--dx',`${Math.cos(ang)*dist}px`);
    s.style.setProperty('--dy',`${Math.sin(ang)*dist}px`);
    document.body.appendChild(s); setTimeout(()=>s.remove(),700);
  }
}

/* ==== Events ==== */
answerInput.addEventListener('input', evaluate);
document.addEventListener('keydown', e=>{ if(e.key==='Enter'){ evaluate(); }});
newBtn.addEventListener('click', newProblem);
make10Btn.addEventListener('click', ()=>{ make10=!make10; make10Btn.classList.toggle('primary', make10); newProblem(); });
rangeSel.addEventListener('change', ()=>{ maxN=parseInt(rangeSel.value,10); newProblem(); });
levelSel.addEventListener('change', ()=>{ level=parseInt(levelSel.value,10); newProblem(); });
voiceBtn.addEventListener('click', ()=>{
  voiceOn=!voiceOn;
  voiceBtn.textContent = voiceOn ? 'üó£Ô∏è Voice On' : 'ü§ê Voice Off';
  if(!voiceOn && window.speechSynthesis){ try{ window.speechSynthesis.cancel(); }catch(e){} }
});

/* Important: ensure audio/voices after first user interaction */
document.addEventListener('click', function once(){
  ensureAudio();
  if(window.speechSynthesis){ prepareVoices(); }
  document.removeEventListener('click', once);
});

/* ==== Init ==== */
buildKeypad();
newProblem();

})();
</script>
</body>
</html>
